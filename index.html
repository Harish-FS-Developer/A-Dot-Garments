<!DOCTYPE html>
<html oncontextmenu="return false">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>A DOT GARMENTS • POS</title>
    <link rel="icon" href="./adot2.png">

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&family=Manrope:wght@400;500;600&display=swap" rel="stylesheet" />

    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <header class="app-header">
        <div class="brand-block">
            <h1>A DOT GARMENTS</h1>
            <div class="brand-meta">
                <span class="tagline">Premium Menswear</span>
                <span class="contact">Call: 9361008718</span>
            </div>
        </div>
        <div class="header-controls">
            <nav class="categories" id="categoryTabs"></nav>
            <div class="top-actions">
                <button id="payNowTopBtn" class="btn primary">Pay Now</button>
                <button id="printBillTopBtn" class="btn subtle">Print Bill</button>
                <button id="downloadPngTopBtn" class="btn subtle">Bill PNG</button>
                <button id="clearCartTopBtn" class="btn danger">Clear Cart</button>
                <button id="adminToggleBtn" class="btn outline">Manage</button>
            </div>
        </div>
    </header>

    <main class="layout">
        <section class="menu-section">
            <div id="menuGrid" class="menu-grid"></div>
            <div class="pagination" id="pagination">
                <button class="btn" id="prevPageBtn">Prev</button>
                <span class="page-info" id="pageInfo">Page 1</span>
                <button class="btn" id="nextPageBtn">Next</button>
            </div>
        </section>

        <aside class="cart-section">
            <h2>Cart</h2>
            <div id="cartList" class="cart-list"></div>

            <div class="customer-fields">
                <label>
                    Customer Name
                    <input id="customerNameInput" type="text" placeholder="Walk-in Customer" />
                </label>
                <label>
                    Mobile Number
                    <input id="customerPhoneInput" type="tel" placeholder="10-digit mobile" />
                </label>
            </div>

            <div class="cart-summary">
                <div class="totals-box">
                    <div class="row">
                        <span>Subtotal</span>
                        <strong id="rawSubtotalText">₹0</strong>
                    </div>
                    <div class="row">
                        <span>Offer / Discount</span>
                        <input id="discountInput" type="number" value="0" min="0" step="1" />
                    </div>
                    <div class="row">
                        <span>Final Bill</span>
                        <strong id="subtotalText">₹0</strong>
                    </div>
                </div>
                <div class="cart-actions">
                    <button id="payNowBtn" class="btn primary">Pay Now</button>
                    <button id="printBillBtn" class="btn subtle">Print Bill</button>
                    <button id="downloadPngBtn" class="btn subtle">Bill PNG</button>
                    <button id="clearCartBtn" class="btn danger">Clear Cart</button>
                </div>
            </div>
        </aside>
    </main>

    <section id="adminPanel" class="admin-panel hidden">
        <div class="admin-content">
            <div class="admin-header">
                <h2>Admin</h2>
                <button id="adminCloseBtn" class="icon-btn" aria-label="Close">✕</button>
            </div>
            <div class="admin-columns">
                <div class="admin-card">
                    <h3>Add / Edit Item</h3>
                    <form id="itemForm">
                        <input type="hidden" id="itemId" />
                        <label>
                            Name
                            <input id="itemName" type="text" required />
                        </label>
                        <label>
                            Category
                            <select id="itemCategory" required></select>
                        </label>
                        <label>
                            Price (₹)
                            <input id="itemPrice" type="number" min="0" step="0.01" required />
                        </label>
                        <label>
                            Stock
                            <input id="itemStock" type="number" min="0" value="0" />
                        </label>
                        <label>
                            Image URL
                            <input id="itemImageUrl" type="url" placeholder="https://example.com/image.jpg" />
                        </label>
                        <label>
                            Or Upload Image
                            <input id="itemImageFile" type="file" accept="image/*" />
                        </label>
                        <div class="form-actions">
                            <button class="btn primary" type="submit">Save Item</button>
                            <button class="btn subtle" type="reset" id="itemFormReset">Reset</button>
                        </div>
                    </form>
                </div>
                <div class="admin-card">
                    <h3>Menu Items</h3>
                    <div id="adminItemList" class="admin-item-list"></div>
                </div>
            </div>
            <div class="admin-columns">
                <div class="admin-card">
                    <h3>Settings</h3>
                    <form id="settingsForm">
                        <label>
                            QR Image URL
                            <input id="qrUrl" type="url" placeholder="https://example.com/qr.png" />
                        </label>
                        <label>
                            Or Upload QR Image
                            <input id="qrFile" type="file" accept="image/*" />
                        </label>
                        <div class="form-actions">
                            <button class="btn subtle" type="submit">Save Settings</button>
                        </div>
                    </form>
                </div>
                <div class="admin-card">
                    <h3>Sales Reports</h3>
                    <section class="report-section">
                        <header>
                            <h4>Daily Summary</h4>
                            <button id="exportDailyCsvBtn" class="btn subtle">Export CSV</button>
                        </header>
                        <div id="salesReportDaily" class="report-table"></div>
                    </section>
                    <section class="report-section">
                        <header>
                            <h4>Monthly Summary</h4>
                            <button id="exportMonthlyCsvBtn" class="btn subtle">Export CSV</button>
                        </header>
                        <div id="salesReportMonthly" class="report-table"></div>
                    </section>
                </div>
            </div>
        </div>
    </section>

    <div id="qrModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="qrTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="qrTitle">Scan to Pay</h3>
                <button id="qrCloseBtn" class="icon-btn" aria-label="Close">✕</button>
            </div>
            <div class="modal-body">
                <img id="qrImage" alt="Payment QR" />
                <div class="payment-details">
                    <label>
                        Payment Method
                        <select id="paymentMethodSelect">
                            <option value="Cash">Cash</option>
                            <option value="UPI">UPI</option>
                            <option value="Card">Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Other">Other</option>
                        </select>
                    </label>
                    <label>
                        Reference / UPI ID (optional)
                        <input id="paymentReferenceInput" type="text" placeholder="Txn ID or notes" />
                    </label>
                </div>
                <p class="muted">After receiving payment, set the details and click “Mark as Paid”.</p>
            </div>
            <div class="modal-footer">
                <button id="markPaidBtn" class="btn primary">Mark as Paid</button>
            </div>
        </div>
    </div>

    <section id="printArea" class="print-area">
        <div class="receipt">
            <div class="receipt-header">
                <div>
                    <img src="./adot2.png" class="receipt-logo-small" alt="Logo">
                    <h3 class="shopname">A DOT GARMENTS</h3>
                    <p class="muted">Premium Menswear</p>
                </div>
                <div class="receipt-meta">
                    <p id="receiptInvoice"></p>
                    <p>Call: 9361008718</p>
                    <p id="receiptDate"></p>
                </div>
            </div>

            <div class="receipt-customer">
                <div><strong>Customer:</strong> <span id="receiptCustomerName">Walk-in Customer</span></div>
                <div><strong>Mobile:</strong> <span id="receiptCustomerPhone">-</span></div>
            </div>

            <table id="receiptTable">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="right">Subtotal</td>
                        <td class="right"><span id="receiptSubtotal">₹0</span></td>
                    </tr>
                    <tr>
                        <td colspan="3" class="right">Discount</td>
                        <td class="right"><span id="receiptDiscount">₹0</span></td>
                    </tr>
                    <tr>
                        <td colspan="3" class="right"><strong>Final Total</strong></td>
                        <td class="right"><strong><span id="receiptGrandTotal">₹0</span></strong></td>
                    </tr>
                </tfoot>
            </table>

            <div class="receipt-payment">
                <div><strong>Payment Method:</strong> <span id="receiptPaymentMethod">Pending</span></div>
                <div><strong>Reference:</strong> <span id="receiptPaymentRef">-</span></div>
            </div>

            <div class="receipt-footer">
                <p>Thank you for choosing A DOT GARMENTS.</p>
                <p class="muted">Please retain this bill for your records.</p>
            </div>
        </div>
    </section>

    <div id="authModal" class="modal auth-modal" role="dialog" aria-modal="true" aria-labelledby="authTitle" style="display: none;">
        <div class="modal-content">
            <h3 id="authTitle">POS Login (Owner Access)</h3>
            <form id="authForm">
                <label>
                    Email
                    <input id="authEmail" type="email" required placeholder="owner@adotgarments.com" />
                </label>
                <label>
                    Password
                    <input id="authPassword" type="password" required placeholder="••••••••" />
                </label>
                <div class="modal-footer" style="justify-content: center; margin-top: 15px;">
                    <button id="authLoginBtn" class="btn primary" type="submit">Login Securely</button>
                </div>
            </form>
        </div>
    </div>

    <!-- html2canvas for PNG bill export -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <!-- Firebase config & exports -->
    <script type="module">
      import { 
        initializeApp 
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

      import { 
        getFirestore, 
        collection, 
        addDoc, 
        getDocs, 
        orderBy, 
        limit, 
        query,
        doc,
        setDoc,
        deleteDoc,
        updateDoc,
        getDoc
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      import { 
        getAuth, 
        signInWithEmailAndPassword, 
        onAuthStateChanged, 
        signOut 
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyC8grCcgyG0RCei2I6FYFyzqZNkSEL_HUY",
        authDomain: "adot-pos-db.firebaseapp.com",
        projectId: "adot-pos-db",
        storageBucket: "adot-pos-db.firebasestorage.app",
        messagingSenderId: "95595432182",
        appId: "1:95595432182:web:4253440f50b97c550c44d7",
        measurementId: "G-KBP22DMM9N"
      };

      const app = initializeApp(firebaseConfig);
      window.db = getFirestore(app);
      window.auth = getAuth(app); 
      
      // expose for app.js
      window.signInWithEmailAndPassword = signInWithEmailAndPassword;
      window.onAuthStateChanged = onAuthStateChanged;
      window.signOut = signOut;

      window.collection = collection;
      window.addDoc = addDoc;
      window.getDocs = getDocs;
      window.orderBy = orderBy;
      window.limit = limit;
      window.query = query;
      window.doc = doc;
      window.setDoc = setDoc;
      window.deleteDoc = deleteDoc;
      window.updateDoc = updateDoc;
      window.getDoc = getDoc;

      // save sale
      window.saveSaleToCloud = async function(saleData) {
          try {
              const salesCollection = collection(window.db, "sales");
              await addDoc(salesCollection, saleData);
              return true;
          } catch (e) {
              console.error("Firebase Save Error:", e);
              return false;
          }
      };

      // load sales
      window.loadRecentSalesFromCloud = async function() {
          if (!window.db) return [];
          const salesRef = collection(window.db, "sales");
          const q = query(salesRef, orderBy("timestampISO", "desc"), limit(100)); 
          const querySnapshot = await getDocs(q);
          let sales = [];
          querySnapshot.forEach((docSnap) => {
              sales.push(docSnap.data());
          });
          return sales;
      };
    </script>

    <!-- Main app logic -->
    <script src="app.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(() => {});
        }
    </script>
</body>
</html>
